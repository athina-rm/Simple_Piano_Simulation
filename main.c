#include <avr/interrupt.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include <stdio.h>
#include <math.h>
#include <util/delay.h>

#include "serial.h"
#include "timer.h"
#include "pushbutton.h"

volatile uint32_t f, time_tracker, newTone;
//volatile uint32_t sine_values[2222];
//const uint32_t sine_values[2222] PROGMEM;
const static uint32_t sine_values[223] ={127,131,134,138,141,145,149,152,156,159,163,166,169,173,176,179,183,186,189,192,195,198,201,204,207,
210,213,215,218,220,223,225,227,229,232,234,236,237,239,241,242,244,245,247,248,249,250,251,252,252,253,253,254,254,254,254,254,254,254,254,253,
253,252,252,251,250,249,248,247,245,244,243,241,239,238,236,234,232,230,227,225,223,220,218,215,213,210,207,204,202,199,196,193,189,186,183,180,
176,173,170,166,163,159,156,152,149,145,142,138,135,131,127,124,120,117,113,109,106,102,99,95,92,88,85,82,78,75,72,68,65,62,59,56,53,50,47,44,
42,39,37,34,32,29,27,25,23,21,19,17,15,13,12,10,9,8,6,5,4,3,2,2,1,1,0,0,0,0,0,0,0,0,0,1,2,2,3,4,5,6,7,8,10,11,13,15,16,18,20,22,24,26,29,31,33,
36,38,41,44,46,49,52,55,58,61,64,67,71,74,77,81,84,87,91,94,98,101,105,108,112,116,119,123,126};


ISR (TIMER2_COMPA_vect)
{        
        
           
}

int main (void) 
{
        uart_init();
        timer2_init();
        timer0_init();	
        //button_init();        
        char input;
        uint32_t t=0;       
        //generating a table for one sine wave with frequency 20Hz-min freq expected with samples at 44.44kHz/22.5us
        //generating a table for one sine wave with frequency 200Hz-min freq expected with samples at 44.44kHz/22.5us
        /*const uint32_t sine_values[] ={127,129,131,132,134,136,138,140,141,143,145,147,149,150,152,154,156,157,159,161,163,164,
        166,168,169,171,173,174,176,178,179,181,183,184,186,188,189,191,192,194,195,197,198,200,201,203,204,206,207,208,210,211,213,214,215,
        216,218,219,220,221,223,224,225,226,227,228,229,231,232,233,234,235,236,236,237,238,239,240,241,242,242,243,244,245,245,246,247,247,
        248,248,249,249,250,250,251,251,252,252,252,253,253,253,253,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,253,
        253,253,253,252,252,252,251,251,250,250,249,249,248,248,247,247,246,245,245,244,243,243,242,241,240,239,238,238,237,236,235,234,233,
        232,231,230,229,227,226,225,224,223,222,220,219,218,217,215,214,213,211,210,209,207,206,204,203,202,200,199,197,196,194,193,191,189,
        188,186,185,183,181,180,178,176,175,173,171,170,168,166,165,163,161,159,158,156,154,152,151,149,147,145,144,142,140,138,136,135,133,
        131,129,127,126,124,122,120,118,117,115,113,111,109,108,106,104,102,101,99,97,95,93,92,90,88,87,85,83,82,80,78,76,75,73,72,70,68,67,        
        65,64,62,61,59,57,56,54,53,52,50,49,47,46,44,43,42,40,39,38,37,35,34,33,32,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,13,
        12,11,10,10,9,8,8,7,6,6,5,5,4,4,3,3,2,2,2,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,2,2,2,3,3,3,4,4,5,5,6,7,7,8,8,9,10,11,11,
        12,13,14,15,15,16,17,18,19,20,21,22,23,24,25,26,27,29,30,31,32,33,35,36,37,38,40,41,42,44,45,46,48,49,51,52,54,55,57,58,60,61,63,64, 
        66,67,69,71,72,74,76,77,79,81,82,84,86,87,89,91,92,94,96,98,99,101,103,105,107,108,110,112,114,115,117,119,121,123,124,126,128};*/
        //uint32_t sine_values[445];
            
        /*f=200;
        //const uint32_t sine_values[] ={127,225,255,200,127,80,0,65,127};
        uint32_t sine_values[223];
        double sampling_pd = 22.5*pow(10,-6);
        double t= 0;
        uint32_t i;
        printf_P(PSTR("lookuptable creating"));
        while (i<223){
                uint32_t value = (sin(2*3.142*f*t)+1)/2*255;  //f=20, t=i*22.5*pow(10,-6)           
                sine_values[i++] = value;                
                printf ("%u,",value);
                t+=sampling_pd;                
        }*/
        /*printf_P(PSTR("lookuptable : {"));
        for(int j=0;j<sizeof(sine_values)/sizeof(sine_values[0]);j++){
                //printf_P(PSTR("%u"),pgm_read_byte(&sine_values[j]));
                printf_P(PSTR("%u"),sine_values[j]);
                printf (", ");
        }
        printf ("}");*/
        
        sei();                                  //status register (SREG) â€“ I: Global Interrupt Enable in the is set (one) to enable interrupts
        
        while (1) {
                if (UCSR0A & (1 << RXC0)){
                        input=UDR0;                        
                        newTone=1;
                        t=1;
                        switch(input){
                                case 'c' : f=200;    //f=261;
                                        break;
                                case 'd' : f = 294;
                                        break;
                                case 'e' : f=329;
                                        break;
                                case 'f' : f = 349;
                                        break;
                                case 'g' : f = 392;
                                        break;
                                case 'a' : f = 440;
                                        break;
                                case 'b' : f = 493;
                                        break;
                        }                        
                }
                if((t < 5000 && t>0) || newTone){                      
                        newTone=0;                        
                        uint32_t i=(t*(f/200))%223;
                        printf ("%u : ",i);
                        printf ("%u \n",sine_values[i]);                        
                        t+=1;
                        if (t >=5000){
                                t=0;
                        }
                }                                           
        }
}